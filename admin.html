<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>⚙️ 管理員後台</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 700px;
    margin: 50px auto;
    padding: 20px;
    background: #f7f9fc;
    color: #222;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  }
  h1 {
    text-align: center;
    color: #5865F2;
  }
  #user-info {
    margin-bottom: 20px;
    font-weight: 600;
  }
  #logout-btn {
    background-color: #5865F2;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    cursor: pointer;
    float: right;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }
  th {
    background-color: #5865F2;
    color: white;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="firebase.js"></script>
</head>
<body>
  <h1>⚙️ 管理員後台</h1>
  <div id="user-info"></div>
  <button id="logout-btn">登出</button>

  <h2>候選人票數</h2>
  <table id="results-table">
    <thead>
      <tr><th>候選人名稱</th><th>票數</th></tr>
    </thead>
    <tbody>
      <tr><td colspan="2">載入中...</td></tr>
    </tbody>
  </table>

<script>
  const clientId = '1399942836383781025';
  const redirectUri = encodeURIComponent(window.location.origin + '/admin.html');
  const scope = encodeURIComponent('identify');
  const oauthUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;

  const allowedAdmins = ['你的DiscordID']; // <-- 這裡填入允許的 Discord 用戶ID（字串陣列）

  const logoutBtn = document.getElementById('logout-btn');
  const userInfoDiv = document.getElementById('user-info');
  const resultsTableBody = document.querySelector('#results-table tbody');

  function getTokenFromHash() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }

  async function fetchDiscordUser(token) {
    const res = await fetch('https://discord.com/api/users/@me', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error('無法取得使用者資訊');
    return await res.json();
  }

  let currentUser = null;

  async function init() {
    const token = getTokenFromHash();
    if (!token) {
      window.location.href = oauthUrl;
      return;
    }
    try {
      currentUser = await fetchDiscordUser(token);
      if (!allowedAdmins.includes(currentUser.id)) {
        alert('你沒有管理員權限');
        window.location.href = 'login.html';
        return;
      }
      userInfoDiv.textContent = `管理員：${currentUser.username}#${currentUser.discriminator}`;
      history.replaceState(null, '', window.location.pathname);
      loadResults();
    } catch (e) {
      alert('登入失敗，請重新登入');
      window.location.href = oauthUrl;
    }
  }

  function loadResults() {
    const db = firebase.database();
    const candidatesRef = db.ref('candidates');
    const votesRef = db.ref('votes');

    candidatesRef.once('value').then(candidatesSnap => {
      const candidates = candidatesSnap.val() || {};
      votesRef.once('value').then(votesSnap => {
        const votes = votesSnap.val() || {};

        // 統計票數
        const counts = {};
        for (const voteId in votes) {
          const candidateId = votes[voteId].candidateId;
          counts[candidateId] = (counts[candidateId] || 0) + 1;
        }

        resultsTableBody.innerHTML = '';

        for (const id in candidates) {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          tdName.textContent = candidates[id].name;
          const tdCount = document.createElement('td');
          tdCount.textContent = counts[id] || 0;
          tr.appendChild(tdName);
          tr.appendChild(tdCount);
          resultsTableBody.appendChild(tr);
        }
      });
    });
  }

  logoutBtn.onclick = () => {
    // 清除 URL hash 重新導向登入
    history.replaceState(null, '', window.location.pathname);
    window.location.href = 'login.html';
  };

  window.onload = init;
</script>
</body>
</html>
